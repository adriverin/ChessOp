<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Opening Master</title>
    
    <!-- Dependencies -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #121212;
            --panel-color: #1e1e1e;
            --accent-color: #4CAF50;
            --text-color: #e0e0e0;
            --border-color: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            user-select: none; 
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }

        /* --- SCREENS --- */
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .active-screen { display: flex; }

        /* --- MENU LAYOUT --- */
        #main-menu {
            justify-content: flex-start;
        }

        #opening-list-container {
            width: 100%;
            max-width: 1100px;
            display: flex;
            flex-direction: column;
            gap: 30px;
            padding-bottom: 50px;
        }

        .category-header {
            width: 100%;
            border-bottom: 1px solid var(--accent-color);
            margin-bottom: 15px;
            padding-bottom: 5px;
            font-size: 1.1rem;
            color: var(--accent-color);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .opening-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 Columns */
            gap: 12px;
            width: 100%;
        }

        /* --- CARD STYLING --- */
        .opening-card {
            background-color: var(--panel-color);
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 50px;
        }

        .opening-card:hover {
            transform: translateY(-2px);
            background-color: #2a2a2a;
            border-color: var(--accent-color);
        }

        .card-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            overflow: hidden;
        }

        .card-info h3 { 
            margin: 0; 
            font-size: 0.95rem; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-tags { 
            display: flex; 
            gap: 5px; 
            flex-wrap: wrap;
        }

        .tag { 
            background: #333; 
            padding: 2px 6px; 
            border-radius: 3px; 
            font-size: 0.7rem;
            color: #aaa;
        }

        .line-count {
            background-color: #333;
            color: #fff;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            white-space: nowrap;
            margin-left: 10px;
            min-width: 60px;
            text-align: center;
        }
        .has-lines { background-color: var(--accent-color); }

        /* --- GAME SCREEN --- */
        #game-screen { justify-content: center; align-items: center; }

        #game-container {
            display: flex;
            gap: 20px;
            width: 100%;
            max-width: 1000px;
            height: 550px;
            align-items: center;
            justify-content: center;
        }

        #board-area {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        #board {
            width: 450px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border: 4px solid #333;
        }

        .captured-bar {
            height: 25px;
            background-color: #1a1a1a;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 5px;
        }
        .captured-piece { width: 18px; height: 18px; margin-right: -5px; }

        .dashboard {
            flex: 1;
            background-color: var(--panel-color);
            height: 500px;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 400px;
        }

        .dash-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
        }

        .btn-menu { background-color: #444; padding: 5px 10px; font-size: 0.8rem; border-radius: 4px; color: white; border: none; cursor: pointer;}
        
        #move-log {
            flex-grow: 1;
            background-color: #121212;
            border: 1px solid #333;
            border-radius: 6px;
            margin-bottom: 10px;
            overflow-y: auto;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .log-entry {
            background-color: #262626;
            padding: 6px 10px;
            border-radius: 4px;
            border-left: 3px solid #444;
            font-size: 0.9rem;
        }
        .log-entry.correct { border-left-color: var(--accent-color); }
        .log-desc { display: block; font-size: 0.8rem; color: #ffd700; font-style: italic; margin-top: 2px;}

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        button {
            padding: 10px;
            font-size: 13px;
            cursor: pointer;
            border-radius: 4px;
            border: none;
            color: white;
            font-weight: bold;
        }
        .btn-reset { background-color: #d63031; }
        .btn-nav { background-color: #0984e3; }
        .btn-hint { background-color: #f0932b; grid-column: span 3; }
        .back-btn { background: none; border: 1px solid #555; width: auto; align-self: flex-start; margin-bottom: 10px; }

        /* Highlights */
        .highlight-move { box-shadow: inset 0 0 3px 3px rgba(255, 255, 0, 0.5); }
        .highlight-selected { box-shadow: inset 0 0 3px 3px #f1c40f; } 
        .highlight-dest { box-shadow: inset 0 0 3px 3px #3498db; cursor: pointer; }
        .highlight-hint-src { box-shadow: inset 0 0 3px 3px #e67e22; }
        .highlight-hint-dest { box-shadow: inset 0 0 3px 3px #e74c3c; }

        @media (max-width: 900px) {
            #game-container { flex-direction: column; height: auto; }
            #board { width: 90vw; max-width: 400px; }
            .dashboard { width: 90vw; max-width: 400px; height: 300px; }
            .opening-list { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 600px) { .opening-list { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <!-- MAIN MENU -->
    <div id="main-menu" class="screen active-screen">
        <h1 style="margin-bottom: 5px; font-size: 2rem;">Chess Opening Master</h1>
        <p style="color: #666; margin-top:0; margin-bottom: 30px;">Select an opening to train</p>
        <div id="opening-list-container"></div>
    </div>

    <!-- VARIATION MENU -->
    <div id="variation-menu" class="screen">
        <div style="width: 100%; max-width: 900px;">
            <button class="back-btn" onclick="showMainMenu()"><i class="fas fa-arrow-left"></i> Main Menu</button>
            <h2 id="selected-opening-title" style="color: var(--accent-color); margin-bottom: 15px;">Opening</h2>
            <div id="variation-list-container" class="opening-list"></div>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen" class="screen">
        <div id="game-container">
            <div id="board-area">
                <div class="captured-bar" id="captures-top"></div>
                <div id="board"></div>
                <div class="captured-bar" id="captures-bottom"></div>
            </div>

            <div class="dashboard">
                <div class="dash-header">
                    <strong id="active-variation-title" style="color: var(--accent-color);">Variation</strong>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-menu" onclick="showVariationMenu()"><i class="fas fa-list"></i> Change</button>
                        <button class="btn-menu" onclick="showMainMenu()"><i class="fas fa-home"></i></button>
                    </div>
                </div>

                <div id="move-log">
                    <div class="log-entry" style="text-align:center; color:#666;">Game Start.</div>
                </div>

                <div class="controls-grid">
                    <button class="btn-nav" id="prev-btn"><i class="fas fa-step-backward"></i></button>
                    <button class="btn-reset" id="reset-btn"><i class="fas fa-sync"></i></button>
                    <button class="btn-nav" id="next-btn"><i class="fas fa-step-forward"></i></button>
                    <button class="btn-hint" id="hint-btn"><i class="fas fa-lightbulb"></i> Hint</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <script>
        const audioBase = "https://cdn.jsdelivr.net/gh/lichess-org/lila@master/public/sound/standard/";
        const sounds = {
            move: new Audio(audioBase + 'Move.mp3'),
            capture: new Audio(audioBase + 'Capture.mp3'),
            notify: new Audio(audioBase + 'GenericNotify.mp3'),
            finish: new Audio(audioBase + 'Victory.mp3')
        };
        
        function playSound(type) {
            const s = sounds[type].cloneNode();
            if(type==='move') s.volume=0.5;
            s.play().catch(()=>{});
        }
        document.body.addEventListener('click', ()=>{
            const s=new Audio(audioBase+'Move.mp3'); s.volume=0; s.play().catch(()=>{});
        }, {once:true});

        // ==========================================
        // 1. DATA DATABASE
        // ==========================================

        // --- VIENNA VARIATIONS ---
        const viennaVariations = [
            {
                id: "vienna_trap",
                name: "Queen Trap Line",
                moves: [
                    { san: "e4", desc: "Control center." }, { san: "e5", desc: "Black matches." },
                    { san: "Nc3", desc: "Vienna Game." }, { san: "Nf6", desc: "Falkbeer variation." },
                    { san: "f4", desc: "The Gambit." }, { san: "exf4", desc: "Accepted." },
                    { san: "e5", desc: "Kick the Knight." }, { san: "Qe7", desc: "Pinning the pawn." },
                    { san: "Qe2", desc: "Unpinning." }, { san: "Ng8", desc: "Knight retreats." },
                    { san: "Nf3", desc: "Develop King side." }, { san: "d6", desc: "Black breaks center." },
                    { san: "Nd5", desc: "Attack Queen and c7." }, { san: "Qd7", desc: "Defend c7." },
                    { san: "exd6+", desc: "Discovered Check!" }, { san: "Kd8", desc: "King runs." },
                    { san: "dxc7+", desc: "Forking King/Queen." }, { san: "Qxc7", desc: "Forced take." },
                    { san: "Nxc7", desc: "Win the Queen." }
                ]
            },
            {
                id: "vienna_main",
                name: "Steinitz Main Line",
                moves: [
                    { san: "e4", desc: "Control center." }, { san: "e5", desc: "Black matches." },
                    { san: "Nc3", desc: "Vienna Game." }, { san: "Nf6", desc: "Falkbeer." },
                    { san: "f4", desc: "Gambit." }, { san: "exf4", desc: "Accepted." },
                    { san: "e5", desc: "Kick." }, { san: "Ng8", desc: "Retreat." },
                    { san: "Nf3", desc: "Develop." }, { san: "d6", desc: "Challenge." },
                    { san: "d4", desc: "Full center control." }
                ]
            },
            {
                id: "vienna_declined",
                name: "Vienna Gambit Declined",
                moves: [
                    { san: "e4", desc: "Control center." }, { san: "e5", desc: "Black matches." },
                    { san: "Nc3", desc: "Vienna Game." }, { san: "Nf6", desc: "Falkbeer." },
                    { san: "f4", desc: "Gambit." }, { san: "d6", desc: "Declined." },
                    { san: "Nf3", desc: "Develop." }, { san: "Nc6", desc: "Develop." }
                ]
            }
        ];

        // --- RUY LOPEZ VARIATIONS ---
        const ruyLopezVariations = [
            {
                id: "ruy_berlin", name: "Berlin Defense (The Wall)",
                moves: [
                    {san:"e4",desc:"King's Pawn."},{san:"e5",desc:"Symmetrical."},{san:"Nf3",desc:"Attack e5."},{san:"Nc6",desc:"Defend e5."},{san:"Bb5",desc:"The Ruy López! Pressure on the defender."},{san:"Nf6",desc:"Berlin Defense. Attacking e4 immediately."},{san:"O-O",desc:"Castle. Ignoring the e4 threat."},{san:"Nxe4",desc:"Black takes the pawn."},{san:"d4",desc:"Striking back in the center."},{san:"Nd6",desc:"Knight retreats, attacking Bishop."},{san:"Bxc6",desc:"Exchange."},{san:"dxc6",desc:"Black captures away from center."},{san:"dxe5",desc:"Recapturing pawn."},{san:"Nf5",desc:"Knight moves to safety."},{san:"Qxd8+",desc:"Queen trade."},{san:"Kxd8",desc:"King is stuck in center, but solid."}
                ]
            },
            {
                id: "ruy_exchange", name: "Exchange Variation",
                moves: [
                    {san:"e4",desc:"King's Pawn."},{san:"e5",desc:"Symmetrical."},{san:"Nf3",desc:"Attack e5."},{san:"Nc6",desc:"Defend e5."},{san:"Bb5",desc:"Ruy López."},{san:"a6",desc:"Morphy Defense. Challenge the Bishop."},{san:"Bxc6",desc:"Exchange Variation. Giving up the Bishop pair for structure damage."},{san:"dxc6",desc:"Black doubles pawns."},{san:"d4",desc:"Open the center immediately."},{san:"exd4",desc:"Trade."},{san:"Qxd4",desc:"Queen takes. White has a pawn majority on K-side."},{san:"Qxd4",desc:"Queen trade."},{san:"Nxd4",desc:"Endgame territory."}
                ]
            },
            {
                id: "ruy_marshall", name: "Marshall Attack",
                moves: [
                    {san:"e4",desc:"King's Pawn."},{san:"e5",desc:"Symmetrical."},{san:"Nf3",desc:"Attack e5."},{san:"Nc6",desc:"Defend e5."},{san:"Bb5",desc:"Ruy López."},{san:"a6",desc:"Morphy."},{san:"Ba4",desc:"Retreat."},{san:"Nf6",desc:"Develop."},{san:"O-O",desc:"Safety."},{san:"Be7",desc:"Prepare castle."},{san:"Re1",desc:"Rook lifts."},{san:"b5",desc:"Expand."},{san:"Bb3",desc:"Retreat."},{san:"O-O",desc:"Safety."},{san:"c3",desc:"Prepare d4."},{san:"d5",desc:"The Marshall! Sacrificing a pawn for attack."},{san:"exd5",desc:"Accept."},{san:"Nxd5",desc:"Recapture."},{san:"Nxe5",desc:"White grabs the pawn."},{san:"Nxe5",desc:"Trade."},{san:"Rxe5",desc:"Rook active."},{san:"c6",desc:"Defend Knight."}
                ]
            }
        ];
        

        // --- ITALIAN GAME VARIATIONS ---
        const italianVariations = [
            {
                id: "italian_giuoco", name: "Giuoco Piano (Main)",
                moves: [
                    {san:"e4",desc:"King's Pawn."},{san:"e5",desc:"Symmetrical."},{san:"Nf3",desc:"Attack."},{san:"Nc6",desc:"Defend."},{san:"Bc4",desc:"Italian Game. Eyeing f7."},{san:"Bc5",desc:"Giuoco Piano. Black mirrors."},{san:"c3",desc:"Preparing d4 push."},{san:"Nf6",desc:"Attacking e4."},{san:"d3",desc:"Giuoco Pianissimo (Quiet Game). Solid play."},{san:"d6",desc:"Solidify."},{san:"O-O",desc:"Safety."},{san:"O-O",desc:"Safety."},{san:"h3",desc:"Preventing Bg4 pin."}
                ]
            },
            {
                id: "italian_fried_liver", name: "Fried Liver Attack",
                moves: [
                    {san:"e4",desc:"King's Pawn."},{san:"e5",desc:"Symmetrical."},{san:"Nf3",desc:"Attack."},{san:"Nc6",desc:"Defend."},{san:"Bc4",desc:"Italian."},{san:"Nf6",desc:"Two Knights Defense."},{san:"Ng5",desc:"The Attack! Targeting f7."},{san:"d5",desc:"Black blocks the Bishop."},{san:"exd5",desc:"White takes."},{san:"Nxd5",desc:"The mistake. Black recaptures."},{san:"Nxf7",desc:"THE SACRIFICE! Forking Queen and Rook."},{san:"Kxf7",desc:"King must take."},{san:"Qf3+",desc:"Check and attacking the Knight."},{san:"Ke6",desc:"King must defend Knight."},{san:"Nc3",desc:"Piling pressure on the pinned Knight."}
                ]
            }
        ];

        // --- SCOTCH GAME VARIATIONS ---
        const scotchVariations = [
            {
                id: "scotch_main", name: "Scotch Main Line",
                moves: [
                    {san:"e4",desc:"King's Pawn."},{san:"e5",desc:"Symmetrical."},{san:"Nf3",desc:"Attack."},{san:"Nc6",desc:"Defend."},{san:"d4",desc:"Scotch Game! Breaking the center early."},{san:"exd4",desc:"Black trades."},{san:"Nxd4",desc:"Recapture."},{san:"Bc5",desc:"Developing and attacking the Knight."},{san:"Be3",desc:"Defending the Knight."},{san:"Qf6",desc:"Adding more pressure on d4."},{san:"c3",desc:"Solidifying the Knight support."},{san:"Nge7",desc:"Developing."},{san:"Bc4",desc:"Active Bishop."}
                ]
            }
        ];

        // --- PETROV DEFENSE VARIATIONS ---
        const petrovVariations = [
            {
                id: "petrov_main", name: "Petrov Main Line",
                moves: [
                    {san:"e4",desc:"King's Pawn."},{san:"e5",desc:"Symmetrical."},{san:"Nf3",desc:"Attack."},{san:"Nf6",desc:"Petrov Defense. Counter-attack."},{san:"Nxe5",desc:"White takes first."},{san:"d6",desc:"Kick the Knight back."},{san:"Nf3",desc:"Retreat."},{san:"Nxe4",desc:"Black regains the pawn."},{san:"d4",desc:"Seize center."},{san:"d5",desc:"Black solidifies."},{san:"Bd3",desc:"Develop."},{san:"Nc6",desc:"Develop."},{san:"O-O",desc:"Safety."}
                ]
            }
        ];

         // --- PHILIDOR DEFENSE VARIATIONS ---
         const philidorVariations = [
            {
                id: "philidor_main", name: "Philidor (Hanham)",
                moves: [
                    {san:"e4",desc:"King's Pawn."},{san:"e5",desc:"Symmetrical."},{san:"Nf3",desc:"Attack."},{san:"d6",desc:"Philidor Defense. Solid but passive."},{san:"d4",desc:"Challenge center."},{san:"Nd7",desc:"Hanham Variation. Keeping center tension."},{san:"Bc4",desc:"Eyeing f7."},{san:"c6",desc:"Controlling squares."},{san:"O-O",desc:"Safety."},{san:"Be7",desc:"Prepare castle."}
                ]
            }
        ];


        // --- SICILIAN DEFENSE VARIATIONS ---
        const sicilianVariations = [
            {
                id: "sicilian_najdorf", name: "Open Sicilian: Najdorf",
                moves: [
                    {san:"e4",desc:"King's Pawn."},{san:"c5",desc:"Sicilian Defense. Fighting for d4 from the flank."},{san:"Nf3",desc:"White prepares d4."},{san:"d6",desc:"Control e5, prepare Nf6."},{san:"d4",desc:"Open Sicilian! Breaking the center."},{san:"cxd4",desc:"Black trades flank pawn for center pawn."},{san:"Nxd4",desc:"Recapture."},{san:"Nf6",desc:"Attack e4."},{san:"Nc3",desc:"Defend e4."},{san:"a6",desc:"The Najdorf. Prevents pieces from using b5."},{san:"Be3",desc:"English Attack setup."},{san:"e5",desc:"Challenging the center immediately."},{san:"Nb3",desc:"Knight retreats to safety."}
                ]
            },
            {
                id: "sicilian_dragon", name: "Open Sicilian: Dragon",
                moves: [
                    {san:"e4",desc:"King's Pawn."},{san:"c5",desc:"Sicilian."},{san:"Nf3",desc:"Develop."},{san:"d6",desc:"Control e5."},{san:"d4",desc:"Open Center."},{san:"cxd4",desc:"Trade."},{san:"Nxd4",desc:"Recapture."},{san:"Nf6",desc:"Attack e4."},{san:"Nc3",desc:"Defend."},{san:"g6",desc:"The Dragon! Preparing to fianchetto the Bishop."},{san:"Be3",desc:"Be3/f3 setup is standard."},{san:"Bg7",desc:"Bishop controls the long diagonal."},{san:"f3",desc:"Solidify e4, prevent Ng4."},{san:"Nc6",desc:"Develop Knight."},{san:"Qd2",desc:"Prepare Queenside castle."},{san:"O-O",desc:"King safety."}
                ]
            },
            {
                id: "sicilian_alapin", name: "Alapin Variation (Anti-Sicilian)",
                moves: [
                    {san:"e4",desc:"King's Pawn."},{san:"c5",desc:"Sicilian."},{san:"c3",desc:"The Alapin. Preparing to build a full center with d4."},{san:"Nf6",desc:"Counter-attack e4."},{san:"e5",desc:"Pushing the pawn to harass the Knight."},{san:"Nd5",desc:"Knight hops to the center."},{san:"d4",desc:" seizing the center."},{san:"cxd4",desc:"Black trades."},{san:"cxd4",desc:"White maintains a strong pawn center."},{san:"d6",desc:"Challenging the e5 pawn."},{san:"Nf3",desc:"Developing."},{san:"Nc6",desc:"Developing."}
                ]
            },
            {
                id: "sicilian_closed", name: "Closed Sicilian",
                moves: [
                    {san:"e4",desc:"King's Pawn."},{san:"c5",desc:"Sicilian."},{san:"Nc3",desc:"Closed Sicilian. Delaying d4 to play a slower game."},{san:"Nc6",desc:"Black develops naturally."},{san:"g3",desc:"Fianchetto setup."},{san:"g6",desc:"Black mirrors."},{san:"Bg2",desc:"Control diagonal."},{san:"Bg7",desc:"Control diagonal."},{san:"d3",desc:"Solid structure."},{san:"d6",desc:"Solid structure."}
                ]
            }
        ];

        // --- FRENCH DEFENSE VARIATIONS ---
        const frenchVariations = [
            {
                id: "french_advance", name: "Advance Variation",
                moves: [
                    {san:"e4",desc:"King's Pawn."},{san:"e6",desc:"French Defense. Solid and prepares d5."},{san:"d4",desc:"Take the center."},{san:"d5",desc:"Challenge e4 immediately."},{san:"e5",desc:"Advance Variation. Gaining space and locking the center."},{san:"c5",desc:"Attacking the d4 pawn base."},{san:"c3",desc:"Reinforcing d4."},{san:"Nc6",desc:"Adding pressure on d4."},{san:"Nf3",desc:"Defending d4."},{san:"Qb6",desc:"Classic French setup. Pressure on b2 and d4."},{san:"a3",desc:"Prepare b4 expansion."}
                ]
            },
            {
                id: "french_exchange", name: "Exchange Variation",
                moves: [
                    {san:"e4",desc:"King's Pawn."},{san:"e6",desc:"French."},{san:"d4",desc:"Center."},{san:"d5",desc:"Challenge."},{san:"exd5",desc:"Exchange. Releasing tension."},{san:"exd5",desc:"Recapture."},{san:"Nf3",desc:"Develop."},{san:"Nf6",desc:"Develop."},{san:"Bd3",desc:"Active Bishop."},{san:"Bd6",desc:"Active Bishop."},{san:"O-O",desc:"Safety."},{san:"O-O",desc:"Safety."}
                ]
            },
            {
                id: "french_winawer", name: "Winawer Variation",
                moves: [
                    {san:"e4",desc:"King's Pawn."},{san:"e6",desc:"French."},{san:"d4",desc:"Center."},{san:"d5",desc:"Challenge."},{san:"Nc3",desc:"Paulsen Attack. Defending e4."},{san:"Bb4",desc:"Winawer! Pinning the Knight."},{san:"e5",desc:"Gaining space."},{san:"c5",desc:"Counter-attack center."},{san:"a3",desc:"Putting the question to the Bishop."},{san:"Bxc3+",desc:"Exchange."},{san:"bxc3",desc:"White has doubled pawns but open lines."},{san:"Ne7",desc:"Developing flexible Knight."}
                ]
            }
        ];

        // --- CARO-KANN VARIATIONS ---
        const caroVariations = [
            {
                id: "caro_advance", name: "Advance Variation",
                moves: [
                    {san:"e4",desc:"King's Pawn."},{san:"c6",desc:"Caro-Kann. Preparing d5."},{san:"d4",desc:"Center."},{san:"d5",desc:"Strike center."},{san:"e5",desc:"Advance. Gaining space."},{san:"Bf5",desc:"Developing Bishop *outside* the pawn chain."},{san:"Nf3",desc:"Develop."},{san:"e6",desc:"Solidifying center (now playing e6 is safe)."},{san:"Be2",desc:"Development."},{san:"c5",desc:"Challenging the center."}
                ]
            },
            {
                id: "caro_classical", name: "Classical Variation",
                moves: [
                    {san:"e4",desc:"King's Pawn."},{san:"c6",desc:"Caro-Kann."},{san:"d4",desc:"Center."},{san:"d5",desc:"Strike."},{san:"Nc3",desc:"Defend e4."},{san:"dxe4",desc:"Take."},{san:"Nxe4",desc:"Recapture."},{san:"Bf5",desc:"Challenge the Knight."},{san:"Ng3",desc:"Knight moves and attacks Bishop."},{san:"Bg6",desc:"Bishop retreats but stays active."},{san:"h4",desc:"Aggressive! Threatening to trap Bishop with h5."},{san:"h6",desc:"Creating an escape square."}
                ]
            }
        ];

        // --- SCANDINAVIAN VARIATIONS ---
        const scandiVariations = [
            {
                id: "scandi_main", name: "Main Line (Mieses)",
                moves: [
                    {san:"e4",desc:"King's Pawn."},{san:"d5",desc:"Scandinavian! Immediate attack."},{san:"exd5",desc:"Take."},{san:"Qxd5",desc:"Queen takes."},{san:"Nc3",desc:"Developing with tempo (attacking Queen)."},{san:"Qa5",desc:"The classic retreat square."},{san:"d4",desc:"Take center."},{san:"Nf6",desc:"Develop."},{san:"Nf3",desc:"Develop."},{san:"c6",desc:"Provide escape for Queen and control d5."},{san:"Bd2",desc:"Preparing discovered attacks."}
                ]
            }
        ];

        // --- PIRC / MODERN VARIATIONS ---
        const pircVariations = [
            {
                id: "pirc_150", name: "150 Attack",
                moves: [
                    {san:"e4",desc:"King's Pawn."},{san:"d6",desc:"Pirc Setup."},{san:"d4",desc:"Center."},{san:"Nf6",desc:"Attack e4."},{san:"Nc3",desc:"Defend."},{san:"g6",desc:"Fianchetto."},{san:"Be3",desc:"Setting up the 150 Attack (English style)."},{san:"Bg7",desc:"Bishop active."},{san:"Qd2",desc:"Battery."},{san:"O-O",desc:"Castle."}
                ]
            }
        ];

        // --- ALEKHINE VARIATIONS ---
        const alekhineVariations = [
            {
                id: "alekhine_modern", name: "Modern Variation",
                moves: [
                    {san:"e4",desc:"King's Pawn."},{san:"Nf6",desc:"Alekhine Defense. Provoking the pawns."},{san:"e5",desc:"White accepts the challenge."},{san:"Nd5",desc:"Knight moves to center."},{san:"d4",desc:"Taking space."},{san:"d6",desc:"Challenging the pawn."},{san:"Nf3",desc:"Developing."},{san:"Bg4",desc:"Pinning."},{san:"Be2",desc:"Unpinning."}
                ]
            }
        ];


        // --- QUEEN'S GAMBIT FAMILY ---
        const qgVariations = [
            {
                id: "qg_main", name: "Queen's Gambit (Main)",
                moves: [
                    {san:"d4",desc:"Queen's Pawn. Control center."},{san:"d5",desc:"Black matches."},{san:"c4",desc:"Queen's Gambit! Trading a flank pawn for the center."},{san:"e6",desc:"Declining the gambit (QGD)."},{san:"Nc3",desc:"Pressure on d5."},{san:"Nf6",desc:"Defending."},{san:"Bg5",desc:"Pinning the Knight."},{san:"Be7",desc:"Unpinning."},{san:"e3",desc:"Solidifying."},{san:"O-O",desc:"Safety."},{san:"Nf3",desc:"Develop."}
                ]
            }
        ];

        const qgdVariations = [
            {
                id: "qgd_exchange", name: "Exchange Variation",
                moves: [
                    {san:"d4",desc:"Center."},{san:"d5",desc:"Center."},{san:"c4",desc:"Gambit."},{san:"e6",desc:"Declined."},{san:"Nc3",desc:"Develop."},{san:"Nf6",desc:"Develop."},{san:"cxd5",desc:"Exchange Variation."},{san:"exd5",desc:"Recapture. The structure is fixed."},{san:"Bg5",desc:"Pin."},{san:"c6",desc:"Solidify d5."},{san:"e3",desc:"Open lines for Bishop."}
                ]
            }
        ];

        const qgaVariations = [
            {
                id: "qga_main", name: "QG Accepted",
                moves: [
                    {san:"d4",desc:"Center."},{san:"d5",desc:"Center."},{san:"c4",desc:"Gambit."},{san:"dxc4",desc:"Accepted! Giving up the center temporarily."},{san:"e3",desc:"Opening diagonal to recover pawn."},{san:"Nf6",desc:"Develop."},{san:"Bxc4",desc:"Recapture."},{san:"e6",desc:"Prepare c5 break."},{san:"Nf3",desc:"Develop."},{san:"c5",desc:"Striking back at the center."},{san:"O-O",desc:"Safety."}
                ]
            }
        ];

        const slavVariations = [
            {
                id: "slav_main", name: "Slav Defense (Main)",
                moves: [
                    {san:"d4",desc:"Center."},{san:"d5",desc:"Center."},{san:"c4",desc:"Gambit."},{san:"c6",desc:"Slav Defense. Solid, keeping the light-squared bishop free."},{san:"Nf3",desc:"Prevent ...e5."},{san:"Nf6",desc:"Develop."},{san:"Nc3",desc:"Pressure."},{san:"dxc4",desc:"Taking now ensures Bishop can develop."},{san:"a4",desc:"Stopping ...b5."},{san:"Bf5",desc:"The point of the Slav. Bishop is out!"}
                ]
            }
        ];

        const semiSlavVariations = [
            {
                id: "semislav_meran", name: "Meran Variation",
                moves: [
                    {san:"d4",desc:"Center."},{san:"d5",desc:"Center."},{san:"c4",desc:"Gambit."},{san:"c6",desc:"Slav."},{san:"Nf3",desc:"Develop."},{san:"Nf6",desc:"Develop."},{san:"Nc3",desc:"Develop."},{san:"e6",desc:"Semi-Slav. Solid triangle structure."},{san:"e3",desc:"Solid."},{san:"Nbd7",desc:"Preparing ...c5 or ...e5."},{san:"Bd3",desc:"Active Bishop."},{san:"dxc4",desc:"Giving up tension."},{san:"Bxc4",desc:"Recapture."},{san:"b5",desc:"Expansion!"},{san:"Bd3",desc:"Retreat."}
                ]
            }
        ];

        // --- INDIAN DEFENSES (1.d4 Nf6) ---
        const nimzoVariations = [
            {
                id: "nimzo_main", name: "Nimzo-Indian (Rubinstein)",
                moves: [
                    {san:"d4",desc:"Center."},{san:"Nf6",desc:"Indian Defense."},{san:"c4",desc:"Space."},{san:"e6",desc:"Prepare ...d5 or ...Bb4."},{san:"Nc3",desc:"Develop."},{san:"Bb4",desc:"Nimzo-Indian. Pinning the Knight."},{san:"e3",desc:"Rubinstein System. Solid."},{san:"O-O",desc:"Safety."},{san:"Bd3",desc:"Develop."},{san:"d5",desc:"Strike center."},{san:"Nf3",desc:"Develop."}
                ]
            }
        ];

        const qidVariations = [
            {
                id: "qid_main", name: "Queen's Indian",
                moves: [
                    {san:"d4",desc:"Center."},{san:"Nf6",desc:"Indian."},{san:"c4",desc:"Space."},{san:"e6",desc:"Solid."},{san:"Nf3",desc:"Preventing Nimzo (Nc3 allows Bb4)."},{san:"b6",desc:"Queen's Indian. Fianchetto."},{san:"g3",desc:"Counter-Fianchetto."},{san:"Ba6",desc:"Modern approach. Attacking c4."},{san:"b3",desc:"Defending c4."},{san:"Bb4+",desc:"Check."}
                ]
            }
        ];

        const kidVariations = [
            {
                id: "kid_classical", name: "KID (Classical)",
                moves: [
                    {san:"d4",desc:"Center."},{san:"Nf6",desc:"Indian."},{san:"c4",desc:"Space."},{san:"g6",desc:"KID Setup."},{san:"Nc3",desc:"Develop."},{san:"Bg7",desc:"Fianchetto."},{san:"e4",desc:"Taking full center."},{san:"d6",desc:"Prevent e5."},{san:"Nf3",desc:"Develop."},{san:"O-O",desc:"Safety."},{san:"Be2",desc:"Classical Setup."},{san:"e5",desc:"Striking back!"},{san:"O-O",desc:"Safety."},{san:"Nc6",desc:"Pressure on d4."},{san:"d5",desc:"Closing the center. The race begins."},{san:"Ne7",desc:"Knight retreats to prepare f5."}
                ]
            }
        ];

        const grunfeldVariations = [
            {
                id: "grunfeld_exchange", name: "Exchange Variation",
                moves: [
                    {san:"d4",desc:"Center."},{san:"Nf6",desc:"Indian."},{san:"c4",desc:"Space."},{san:"g6",desc:"Setup."},{san:"Nc3",desc:"Develop."},{san:"d5",desc:"Grünfeld! Allowing white center to attack it."},{san:"cxd5",desc:"Exchange."},{san:"Nxd5",desc:"Recapture."},{san:"e4",desc:"White takes massive center."},{san:"Nxc3",desc:"Trade."},{san:"bxc3",desc:"White has pawns, Black has activity."},{san:"Bg7",desc:"Fianchetto."},{san:"Nf3",desc:"Develop."},{san:"c5",desc:"Attacking the center immediately."}
                ]
            }
        ];

        // --- OTHER d4 SYSTEMS ---
        const dutchVariations = [
            {
                id: "dutch_stonewall", name: "Stonewall Dutch",
                moves: [
                    {san:"d4",desc:"Center."},{san:"f5",desc:"Dutch Defense. Aggressive/Risky."},{san:"c4",desc:"Space."},{san:"e6",desc:"Solid."},{san:"g3",desc:"Preventing f4 attacks."},{san:"Nf6",desc:"Develop."},{san:"Bg2",desc:"Fianchetto."},{san:"d5",desc:"Stonewall. Locking center control."},{san:"Nf3",desc:"Develop."},{san:"c6",desc:"Fortifying."},{san:"O-O",desc:"Safety."},{san:"Bd6",desc:"Active Bishop."}
                ]
            }
        ];

        const benoniVariations = [
            {
                id: "benoni_modern", name: "Modern Benoni",
                moves: [
                    {san:"d4",desc:"Center."},{san:"Nf6",desc:"Indian."},{san:"c4",desc:"Space."},{san:"c5",desc:"Benoni. Provoking d5."},{san:"d5",desc:"Space gain."},{san:"e6",desc:"Challenging the pawn."},{san:"Nc3",desc:"Develop."},{san:"exd5",desc:"Trade."},{san:"cxd5",desc:"Modern Benoni Structure. White has center, Black has queenside majority."},{san:"d6",desc:"Stopping e5."},{san:"e4",desc:"Center."},{san:"g6",desc:"Fianchetto."}
                ]
            }
        ];

        const benkoVariations = [
            {
                id: "benko_accepted", name: "Benko Gambit",
                moves: [
                    {san:"d4",desc:"Center."},{san:"Nf6",desc:"Indian."},{san:"c4",desc:"Space."},{san:"c5",desc:"Benoni push."},{san:"d5",desc:"Space."},{san:"b5",desc:"Benko Gambit! Sacrificing pawn for pressure."},{san:"cxb5",desc:"Accepted."},{san:"a6",desc:"Undermining."},{san:"bxa6",desc:"White takes."},{san:"g6",desc:"Fianchetto."},{san:"Nc3",desc:"Develop."},{san:"Bxa6",desc:"Black has open files for Rooks."}
                ]
            }
        ];

        const catalanVariations = [
            {
                id: "catalan_open", name: "Catalan (Open)",
                moves: [
                    {san:"d4",desc:"Center."},{san:"Nf6",desc:"Indian."},{san:"c4",desc:"Space."},{san:"e6",desc:"Solid."},{san:"g3",desc:"Catalan. Hybrid of QG and Reti."},{san:"d5",desc:"Center."},{san:"Bg2",desc:"Fianchetto."},{san:"Be7",desc:"Develop."},{san:"Nf3",desc:"Develop."},{san:"O-O",desc:"Safety."},{san:"O-O",desc:"Safety."},{san:"dxc4",desc:"Taking the pawn."}
                ]
            }
        ];

        // --- FLANK OPENINGS ---
        const englishVariations = [
            {
                id: "english_sicilian", name: "Reverse Sicilian",
                moves: [
                    {san:"c4",desc:"English Opening. Control d5."},{san:"e5",desc:"Reversed Sicilian."},{san:"Nc3",desc:"Develop."},{san:"Nf6",desc:"Develop."},{san:"Nf3",desc:"Attack e5."},{san:"Nc6",desc:"Defend."},{san:"g3",desc:"Fianchetto is standard."},{san:"Bb4",desc:"Active play."}
                ]
            }
        ];

        const retiVariations = [
            {
                id: "reti_main", name: "Reti Setup",
                moves: [
                    {san:"Nf3",desc:"Reti Opening. Flexible."},{san:"d5",desc:"Center."},{san:"c4",desc:"Attacking d5 from flank."},{san:"e6",desc:"Support."},{san:"g3",desc:"Fianchetto."},{san:"Nf6",desc:"Develop."},{san:"Bg2",desc:"Control long diagonal."},{san:"Be7",desc:"Develop."},{san:"O-O",desc:"Safety."}
                ]
            }
        ];

        const kiaVariations = [
            {
                id: "kia_setup", name: "King's Indian Attack",
                moves: [
                    {san:"Nf3",desc:"Flexible."},{san:"d5",desc:"Center."},{san:"g3",desc:"KIA Setup (played by White)."},{san:"Nf6",desc:"Develop."},{san:"Bg2",desc:"Fianchetto."},{san:"e6",desc:"Solid."},{san:"d3",desc:"Slow build up."},{san:"c5",desc:"Center space."},{san:"O-O",desc:"Safety."},{san:"Nc6",desc:"Develop."},{san:"Nbd2",desc:"Typical KIA Knight move."},{san:"Be7",desc:"Develop."},{san:"e4",desc:"The point. Strike e4."}
                ]
            }
        ];

        const birdVariations = [
            {
                id: "bird_main", name: "Bird's Opening",
                moves: [
                    {san:"f4",desc:"Bird's Opening. Control e5."},{san:"d5",desc:"Classical response."},{san:"Nf3",desc:"Control e5."},{san:"Nf6",desc:"Develop."},{san:"e3",desc:"Solid."},{san:"g6",desc:"Fianchetto."},{san:"Be2",desc:"Develop."},{san:"Bg7",desc:"Develop."}
                ]
            }
        ];
        
        const larsenVariations = [
            {
                id: "larsen_main", name: "Nimzo-Larsen Attack",
                moves: [
                    {san:"b3",desc:"Larsen's Opening. Control e5/d4 from distance."},{san:"e5",desc:"Seizing center."},{san:"Bb2",desc:"Attacking e5."},{san:"Nc6",desc:"Defending."},{san:"e3",desc:"Opening diagonal."},{san:"Nf6",desc:"Develop."},{san:"Bb5",desc:"Pinning."}
                ]
            }
        ];

        const sokolskyVariations = [
            {
                id: "sokolsky_main", name: "Sokolsky (Orangutan)",
                moves: [
                    {san:"b4",desc:"The Orangutan. Flank expansion."},{san:"e5",desc:"Attacking the pawn."},{san:"Bb2",desc:"Attacking e5."},{san:"Bxb4",desc:"Black takes the pawn."},{san:"Bxe5",desc:"White recovers center pawn."},{san:"Nf6",desc:"Develop."}
                ]
            }
        ];
                
        // --- FULL LIST STRUCTURE ---
        const database = {
            "1.e4 — King’s Pawn Openings": [
                { id: "ruy_lopez", name: "Ruy López", tags: ["White", "Open Game"], variations: ruyLopezVariations },
                { id: "italian", name: "Italian Game", tags: ["White", "Open Game"], variations: italianVariations },
                { id: "scotch", name: "Scotch Game", tags: ["White", "Open Game"], variations: scotchVariations },
                { id: "petrov", name: "Petrov Defense", tags: ["Black", "Open Game"], variations: petrovVariations },
                { id: "vienna", name: "Vienna Game", tags: ["White", "Open Game"], variations: viennaVariations },
                { id: "four_knights", name: "Four Knights Game", tags: ["White", "Open Game"], variations: [] },
                { id: "philidor", name: "Philidor Defense", tags: ["Black", "Open Game"], variations: philidorVariations },
                { id: "sicilian", name: "Sicilian Defense", tags: ["Black", "Semi-Open"], variations: sicilianVariations },
                { id: "french", name: "French Defense", tags: ["Black", "Semi-Open"], variations: frenchVariations },
                { id: "caro", name: "Caro-Kann Defense", tags: ["Black", "Semi-Open"], variations: caroVariations },
                { id: "pirc", name: "Pirc Defense", tags: ["Black", "Semi-Open"], variations: pircVariations },
                { id: "modern", name: "Modern Defense", tags: ["Black", "Semi-Open"], variations: [] },
                { id: "alekhine", name: "Alekhine Defense", tags: ["Black", "Semi-Open"], variations: alekhineVariations },
                { id: "scandi", name: "Scandinavian Defense", tags: ["Black", "Semi-Open"], variations: scandiVariations }
            ],
            "1.d4 — Queen’s Pawn Openings": [
                { id: "qg", name: "Queen’s Gambit", tags: ["White", "Closed"], variations: qgVariations },
                { id: "qgd", name: "QG Declined", tags: ["Black", "Closed"], variations: qgdVariations },
                { id: "qga", name: "QG Accepted", tags: ["Black", "Closed"], variations: qgaVariations },
                { id: "slav", name: "Slav Defense", tags: ["Black", "Closed"], variations: slavVariations },
                { id: "semi_slav", name: "Semi-Slav Defense", tags: ["Black", "Closed"], variations: semiSlavVariations },
                { id: "nimzo", name: "Nimzo-Indian", tags: ["Black", "Indian"], variations: nimzoVariations },
                { id: "qid", name: "Queen’s Indian", tags: ["Black", "Indian"], variations: [] },
                { id: "kid", name: "King’s Indian", tags: ["Black", "Indian"], variations: kidVariations },
                { id: "grunfeld", name: "Grünfeld Defense", tags: ["Black", "Indian"], variations: [] },
                { id: "dutch", name: "Dutch Defense", tags: ["Black", "Other"], variations: dutchVariations },
                { id: "benoni", name: "Benoni Defense", tags: ["Black", "Other"], variations: benoniVariations },
                { id: "benko", name: "Benko Gambit", tags: ["Black", "Other"], variations: benkoVariations },
                { id: "catalan", name: "Catalan Opening", tags: ["White", "Other"], variations: catalanVariations }
            ],
            "Flank Openings": [
                { id: "english", name: "English Opening", tags: ["White", "Flank"], variations: [] },
                { id: "reti", name: "Reti Opening", tags: ["White", "Flank"], variations: [] },
                { id: "kia", name: "King’s Indian Attack", tags: ["White", "Flank"], variations: [] },
                { id: "bird", name: "Bird’s Opening", tags: ["White", "Flank"], variations: [] },
                { id: "larsen", name: "Larsen’s Opening", tags: ["White", "Flank"], variations: [] },
                { id: "sokolsky", name: "Sokolsky Opening", tags: ["White", "Flank"], variations: [] }
            ]
        };

        // ==========================================
        // 2. STATE VARIABLES
        // ==========================================
        let game = new Chess();
        let board = null;
        let currentLine = [];
        let moveIndex = 0;
        let isPlayerTurn = true;
        let selectedSquare = null;
        let playerColor = 'w';
        const startPieces = { p:8, n:2, b:2, r:2, q:1, k:1 };

        function renderMainMenu() {
            const container = document.getElementById('opening-list-container');
            container.innerHTML = '';
            
            for (const [category, openings] of Object.entries(database)) {
                // Wrapper Block
                const block = document.createElement('div');
                block.className = 'category-block';

                // Header
                const header = document.createElement('div');
                header.className = 'category-header';
                header.innerText = category;
                block.appendChild(header);

                // Grid
                const grid = document.createElement('div');
                grid.className = 'opening-list';

                openings.forEach(op => {
                    const card = document.createElement('div');
                    card.className = 'opening-card';
                    
                    // Generate Tags HTML
                    const tagsHtml = op.tags.map(t => `<span class="tag">${t}</span>`).join('');
                    const lineText = op.variations.length === 1 ? 'Line' : 'Lines';

                    card.innerHTML = `
                        <div class="card-info">
                            <h3>${op.name}</h3>
                            <div class="card-tags">${tagsHtml}</div>
                        </div>
                        <div class="line-count ${op.variations.length>0?'has-lines':''}">${op.variations.length} ${lineText}</div>
                    `;
                    card.onclick = () => selectOpening(op);
                    grid.appendChild(card);
                });

                block.appendChild(grid);
                container.appendChild(block);
            }
        }

        function selectOpening(op) {
            const container = document.getElementById('variation-list-container');
            container.innerHTML = '';
            document.getElementById('selected-opening-title').innerText = op.name;
            const pColor = op.tags.includes('Black') ? 'b' : 'w';
            
            if(op.variations.length===0) container.innerHTML='<p style="text-align:center; color:#666; width:100%;">Coming Soon</p>';
            else op.variations.forEach(v => {
                const div = document.createElement('div');
                div.className='opening-card'; 
                div.style.justifyContent='center';
                div.innerHTML=`<h3>${v.name}</h3>`;
                div.onclick = () => startTraining(v, pColor, op.name);
                container.appendChild(div);
            });
            switchScreen('variation-menu');
        }

        function startTraining(variation, color, opName) {
            currentLine = variation.moves;
            playerColor = color;
            document.getElementById('active-variation-title').innerText = `${opName}: ${variation.name}`;
            switchScreen('game-screen');
            setTimeout(() => { initGame(); board.resize(); }, 100);
        }

        function initGame() {
            game.reset();
            moveIndex = 0;
            selectedSquare = null;
            isPlayerTurn = (playerColor === 'w');
            
            document.getElementById('move-log').innerHTML = '<div class="log-entry" style="text-align:center; color:#666;">Game Start.</div>';
            updateCaptures();
            clearHighlights();
            $('#board').off('click');

            let config = {
                draggable: true,
                position: 'start',
                orientation: (playerColor === 'w') ? 'white' : 'black',
                onDragStart: onDragStart,
                onDrop: onDrop,
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            };
            if(board) board.destroy();
            board = Chessboard('board', config);
            $('#board').on('click', '.square-55d63', handleSquareClick);
            
            if (playerColor === 'b') setTimeout(makeOpponentMove, 800);
        }

        function handleSquareClick(evt) {
            if (!isPlayerTurn || game.game_over()) return;
            const classes = evt.currentTarget.className.split(' ');
            const square = classes.find(c => c.startsWith('square-')).replace('square-', '');
            const piece = game.get(square);
            const isOwn = piece && piece.color === game.turn();

            if (selectedSquare) {
                if (attemptMove(selectedSquare, square) === 'success') {
                    selectedSquare = null; 
                    clearHighlights();
                    return;
                }
                if(isOwn) selectSquare(square);
                else { selectedSquare=null; clearHighlights(); }
            } else {
                if (isOwn) selectSquare(square);
            }
        }

        function selectSquare(sq) {
            selectedSquare = sq;
            clearHighlights();
            $(`.square-${sq}`).addClass('highlight-selected');
            game.moves({square:sq, verbose:true}).forEach(m => $(`.square-${m.to}`).addClass('highlight-dest'));
        }

        function onDragStart(source, piece) {
            if (game.game_over() || !isPlayerTurn) return false;
            if ((playerColor==='w' && piece.search(/^b/)!==-1) || (playerColor==='b' && piece.search(/^w/)!==-1)) return false;
            clearHighlights(); selectedSquare = null;
        }

        function onDrop(source, target) {
            if (attemptMove(source, target) === 'snapback') return 'snapback';
        }

        function attemptMove(source, target) {
            if (moveIndex >= currentLine.length) return 'snapback';
            const moveObj = { from: source, to: target, promotion: 'q' };
            const possibleMove = game.move(moveObj);
            
            if (possibleMove === null) return 'snapback';
            
            const expected = currentLine[moveIndex];
            if (possibleMove.san === expected.san) {
                board.position(game.fen());
                possibleMove.flags.includes('c') ? playSound('capture') : playSound('move');
                
                highlightMove(source, target);
                addLogEntry(expected, true);
                updateCaptures();
                clearHighlights(); 
                moveIndex++;
                
                if (moveIndex >= currentLine.length) {
                    playSound('finish');
                    addLogEntry({desc:"Training Complete!"}, true);
                } else {
                    const nextIsWhite = (moveIndex % 2 === 0);
                    if ((playerColor==='w' && !nextIsWhite) || (playerColor==='b' && nextIsWhite)) {
                        isPlayerTurn = false;
                        setTimeout(makeOpponentMove, 600);
                    } else {
                        isPlayerTurn = true;
                    }
                }
                return 'success';
            } else {
                game.undo();
                playSound('notify');
                return 'snapback';
            }
        }

        function makeOpponentMove() {
            if (moveIndex >= currentLine.length) return;
            const step = currentLine[moveIndex];
            game.move(step.san);
            board.position(game.fen());
            step.san.includes('x') ? playSound('capture') : playSound('move');
            
            const history = game.history({verbose:true});
            const last = history[history.length-1];
            highlightMove(last.from, last.to);
            clearHighlights();
            addLogEntry(step, true);
            updateCaptures();
            moveIndex++;
            isPlayerTurn = true;
        }

        function addLogEntry(step, isCorrect) {
            const log = document.getElementById('move-log');
            const div = document.createElement('div');
            div.className = `log-entry ${isCorrect ? 'correct' : 'wrong'}`;
            const num = Math.floor(moveIndex/2) + 1;
            const dot = (moveIndex%2===0) ? '.' : '...';
            if(!step.san) div.innerHTML = step.desc; 
            else div.innerHTML = `<span style="font-weight:bold; color:#888;">${num}${dot} ${step.san}</span> <span class="log-desc">${step.desc||''}</span>`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        function updateCaptures() {
            const counts = { w: {...startPieces}, b: {...startPieces} };
            game.board().forEach(row => row.forEach(p => { if (p) counts[p.color][p.type]--; }));
            
            const getLost = (color) => {
                let lost = [];
                Object.keys(counts[color]).forEach(t => { for(let i=0; i<counts[color][t]; i++) lost.push(color+t.toUpperCase()); });
                return lost;
            };
            
            const topColor = playerColor==='w' ? 'w' : 'b'; // Opponent
            const botColor = playerColor==='w' ? 'b' : 'w'; // Player
            
            renderCaptureBar('captures-top', getLost(topColor));
            renderCaptureBar('captures-bottom', getLost(botColor));
        }

        function renderCaptureBar(id, pieces) {
            const el = document.getElementById(id); el.innerHTML = '';
            pieces.forEach(p => {
                const img=document.createElement('img'); img.src=`https://chessboardjs.com/img/chesspieces/wikipedia/${p}.png`;
                img.className='captured-piece'; el.appendChild(img);
            });
        }

        function highlightMove(source, target) {
            $('.square-55d63').removeClass('highlight-move');
            $(`.square-${source}`).addClass('highlight-move'); $(`.square-${target}`).addClass('highlight-move');
        }
        function clearHighlights() { $('.square-55d63').removeClass('highlight-hint-src highlight-hint-dest highlight-selected highlight-dest'); }
        function switchScreen(id) { $('.screen').removeClass('active-screen'); $(`#${id}`).addClass('active-screen'); }
        function showMainMenu() { switchScreen('main-menu'); }
        function showVariationMenu() { switchScreen('variation-menu'); }

        document.getElementById('reset-btn').addEventListener('click', initGame);
        document.getElementById('prev-btn').addEventListener('click', () => { if(moveIndex>0) { game.undo(); moveIndex--; board.position(game.fen()); updateCaptures(); }});
        document.getElementById('next-btn').addEventListener('click', () => { if(moveIndex<currentLine.length) { const s=currentLine[moveIndex]; game.move(s.san); board.position(game.fen()); addLogEntry(s,true); moveIndex++; updateCaptures(); clearHighlights(); }});
        document.getElementById('hint-btn').addEventListener('click', () => {
            if(moveIndex<currentLine.length) {
                const m = game.moves({verbose:true}).find(x=>x.san===currentLine[moveIndex].san);
                if(m) { clearHighlights(); $(`.square-${m.from}`).addClass('highlight-hint-src'); $(`.square-${m.to}`).addClass('highlight-hint-dest'); }
            }
        });

        renderMainMenu();
        window.addEventListener('resize', ()=> board && board.resize());
    </script>
</body>
</html>